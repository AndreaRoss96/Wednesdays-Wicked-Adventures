# ============================================================
# PIPELINE
# ============================================================
name: CI/CD Pipeline 

on:
  push:
    branches: [feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================================
  # JOB 1: BUILD AND TEST
  # ============================================================
  ci-pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      SEED_ADMIN_PASSWORD: ${{ secrets.SEED_ADMIN_PASSWORD }}
      FLASK_ENV: development
    
    steps:
      # ======================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones disabled for SonarCloud
      
      # ======================================================
      # STEP 2: SETUP PYTHON
      # ======================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # ======================================================
      # PHASE 3: SETUP ENVIRONMENT
      # ======================================================
      - name: Setup Virtual Environment
        id: setup-phase
        run: |
          echo "PHASE 3: SETUP ENVIRONMENT"
          echo "============================="
          echo ""
          echo "Checking environment variables..."
          echo "SECRET_KEY is set: ${{ env.SECRET_KEY != '' }}"
          echo "SEED_ADMIN_PASSWORD is set: ${{ env.SEED_ADMIN_PASSWORD != '' }}"
          echo ""
          echo "Going to: flask_app/src/main"
          cd flask_app/src/main
          echo "Current directory: $(pwd)"
          echo ""
          
          # Create venv 
          echo "Creating virtual environment..."
          python3 -m venv venv
          echo "Venv created at: $(pwd)/venv"
          echo ""
          
          # Activate venv
          echo "Activating venv..."
          source venv/bin/activate
          echo "Venv activated"
          echo "Python: $(which python)"
          echo "Version: $(python --version)"
          echo ""
          
          # Update pip
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          echo ""
          
          # Install requirements 
          echo "Installing requirements.txt..."
          echo "From: ../requirements.txt"
          pip install -r ../requirements.txt
          echo "Requirements installed"
          echo ""
          
          # Install extra packages 
          echo "Checking pytest..."
          if ! pip show pytest >/dev/null 2>&1; then
            echo "Installing pytest..."
            pip install pytest
          fi
          echo "Pytest available"
          echo ""
          
          # Show pytest
          echo "Showing pytest..."
          pip show Flask pytest | grep -E "^(Name|Version):" || true
          echo ""
          
          echo "SETUP COMPLETED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 4: CODE QUALITY - FLAKE8 LINTING
      # ======================================================
      - name: Code Quality - Flake8 Linting
        id: lint-phase
        run: |
          echo "PHASE 4: CODE QUALITY - FLAKE8"
          echo "================================"
          
          # Activate venv and go to project
          echo "Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "Directory: $(pwd)"
          echo ""

          echo "Flake8 version: $(flake8 --version)"
          
          echo "Running critical error checks..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=venv,__pycache__,.git,.pytest_cache
          
          echo "Running extended style checks..."
          flake8 . \
            --count \
            --max-complexity=10 \
            --max-line-length=127 \
            --statistics \
            --exclude=venv,__pycache__,.git,.pytest_cache,*.pyc,*.egg-info \
            --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' || {
              echo ""
              echo "Style warnings found (not blocking pipeline)"
          }
          
          echo "FLAKE8 LINTING COMPLETED"
      
      # ======================================================
      # PHASE 5: SECURITY SCAN (SAST) - BANDIT
      # ======================================================
      - name: Security Scan (SAST)
        id: security-phase
        run: |
          echo "PHASE 5: SECURITY SCAN"
          echo "========================="
          echo ""
          
          # Activate venv and go to project
          echo "Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "Directory: $(pwd)"
          echo ""
          
          # Install bandit if needed
          echo "Checking bandit..."
          if ! pip show bandit >/dev/null 2>&1; then
            echo "Installing bandit..."
            pip install bandit
          fi
          echo "Bandit available"
          echo ""
          
          # Create reports directory
          echo "Creating reports directory..."
          cd ..
          mkdir -p Bandit

          # Run scan
          echo "Running security scan on all Python files..."
          bandit -r ./main/app \
            --skip B101 \
            -f json \
            -o Bandit/Bandit-results.json
          
          # Show summary
          echo ""
          echo "Scan completed. Reports saved in Bandit/"
          echo ""

          if [ -f "Bandit/bandit-results.json" ]; then
            echo "Summary of findings:"
            python -c "
          import json
          with open('Bandit/bandit-results.json') as f:
            data = json.load(f)
          print(f'Total files scanned: {data[\"metrics\"][\"_totals\"][\"loc\"]}')
          print(f'Total issues found: {len(data[\"results\"])}')
          print(f'High severity: {len([r for r in data[\"results\"] if r[\"issue_severity\"] == \"HIGH\"])}')
          print(f'Medium severity: {len([r for r in data[\"results\"] if r[\"issue_severity\"] == \"MEDIUM\"])}')
          print(f'Low severity: {len([r for r in data[\"results\"] if r[\"issue_severity\"] == \"LOW\"])}')
            "
          fi
          
          echo "SECURITY PHASE COMPLETED"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: flask_app/src/Bandit/
      
      # ======================================================
      # PHASE 6: RUN TESTS WITH PYTEST
      # ======================================================
      - name: Run Tests with pytest
        id: test-phase
        run: |
          echo "PHASE 6: RUN TESTS"
          echo "====================="
          echo ""
          
          # Activate venv and go to project
          echo "Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "Directory: $(pwd)"
          echo "Python: $(which python)"
          echo ""
          
          # Check test structure
          echo "Test structure:"
          find . -name "*test*.py" -type f | head -10 || echo "No tests found"
          echo ""
          
          echo "Running pytest..."
          cd "${{ github.workspace }}/flask_app/src"
          python -m pytest --cov=app --cov-report=xml --cov-report=term-missing
          
          echo ""
          echo "TESTS EXECUTED SUCCESSFULLY"

      # ======================================================
      # PHASE 7: SONARCLOUD ANALYSIS
      # ======================================================
      - name: SonarCloud Scan
        id: sonar-phase
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: flask_app/src
          args: >
            -Dsonar.projectKey=AndreaRoss96_Wednesdays-Wicked-Adventures
            -Dsonar.organization=andreaross96
            -Dsonar.verbose=true
            -Dsonar.qualitygate.wait=false
            -Dsonar.scm.disabled=true
      
      # ======================================================
      # PHASE 8: PIPELINE SUMMARY
      # ======================================================
      - name: Pipeline Summary
        if: always()
        run: |
          echo "PHASE 8: PIPELINE SUMMARY"
          echo "============================"
          echo ""
          echo "Results:"
          echo "--------"
          echo "Setup Environment....: ${{ steps.setup-phase.conclusion || 'unknown' }}"
          echo "Flake8 Linting.......: ${{ steps.lint-phase.conclusion || 'unknown' }}"
          echo "Security Scan........: ${{ steps.security-phase.conclusion || 'unknown' }}"
          echo "Test Execution.......: ${{ steps.test-phase.conclusion || 'unknown' }}"
          echo ""
          echo "Overall Status.......: ${{ job.status }}"
          echo ""

          if [ "${{ job.status }}" = "success" ]; then
            echo "PIPELINE COMPLETED SUCCESSFULLY!"
            echo "Environment configured correctly"
            echo "Tests executed"
            echo "Build completed"
            echo "Ready for next steps"
          else
            echo "Some phases failed"
            echo "Check logs for details"
          fi

          echo ""
          echo "========================================"
          echo "PIPELINE EXECUTION COMPLETE"
          echo "========================================"
  
  # ============================================================
  # JOB 2: DOCKER BUILD AND TEST
  # ============================================================
  docker-build:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: ci-pipeline  # runs after CI pipeline succeeds
    timeout-minutes: 15
    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      SEED_ADMIN_PASSWORD: ${{ secrets.SEED_ADMIN_PASSWORD }}
      FLASK_ENV: development
    
    steps:
      # ======================================================
      # STEP 1: CHECKOUT CODE
      # ======================================================
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ======================================================
      # PHASE 1: BUILD DOCKER IMAGE
      # ======================================================
      - name: Build Docker Image
        id: build-phase
        run: |
          echo "PHASE 1: BUILD DOCKER IMAGE"
          echo "============================"
          echo ""
          
          # Go to the directory with Dockerfile
          cd flask_app/src
          echo "Current directory: $(pwd)"
          echo ""
          
          # Verify required files exist
          echo "Verifying build files..."
          if [ ! -f "Dockerfile" ]; then
            echo "ERROR: Dockerfile not found!"
            exit 1
          fi
          if [ ! -f "setup.py" ]; then
            echo "ERROR: setup.py not found!"
            exit 1
          fi
          if [ ! -f "MANIFEST.in" ]; then
            echo "ERROR: MANIFEST.in not found!"
            exit 1
          fi
          if [ ! -f "requirements.txt" ]; then
            echo "ERROR: requirements.txt not found!"
            exit 1
          fi
          echo "All required files are present!"
          echo ""
          
          # Build Docker Image
          echo "Building Docker image..."
          docker build -t wicked-adventures:latest .
          echo "Docker image built successfully"
          echo ""
          
          # Verify the image was created
          echo "Verifying Docker image..."
          docker images | grep wicked-adventures
          echo ""
          
          # Get image details
          echo "Image details:"
          docker images wicked-adventures:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
          echo ""
          
          # Test the image - basic import test
          echo "Testing basic import..."
          docker run --rm wicked-adventures:latest python -c "import app; print('App imports successfully')"
          echo ""
          
          echo "DOCKER BUILD COMPLETED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 2: TEST DOCKER CONTAINER
      # ======================================================
      - name: Test Docker Container
        id: test-phase
        run: |
          echo "PHASE 2: TEST DOCKER CONTAINER"
          echo "==============================="
          echo ""
          
          # Run container with environment variables from secrets
          echo "Starting Docker container with environment variables..."
          docker run -d \
            --name test-wicked \
            -p 5000:5000 \
            -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            -e SEED_ADMIN_PASSWORD="${{ secrets.SEED_ADMIN_PASSWORD }}" \
            -e FLASK_ENV="${{ env.FLASK_ENV }}" \
            wicked-adventures:latest
          
          echo "Container started"
          echo "Container ID: $(docker ps -q -f name=test-wicked)"
          echo ""

          echo "wait for Flask to start..."
          sleep 15  
          echo ""
          
          # check container status
          echo "Container status:"
          docker ps | grep test-wicked
          echo ""
          
          # check container logs
          echo "Container logs:"
          docker logs test-wicked --tail 20
          echo ""
          
          # verify container is running
          if [ "$(docker ps -q -f name=test-wicked)" ]; then
            echo "Container is running"
          else
            echo "Container is not running!"
            docker logs test-wicked
            exit 1
          fi
          echo ""
          
          # test health endpoint 
          echo "Testing container response..."
          if curl -f http://localhost:5000/ --max-time 10 2>/dev/null; then
            echo "Container is responding to HTTP requests"
          else
            echo "Container is not responding on root endpoint"
            echo "Checking if Flask is running..."
            docker exec test-wicked ps aux | grep flask || echo "Flask process check"
          fi
          echo ""
          
          # Get container stats
          echo "Container resource usage:"
          docker stats test-wicked --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          echo ""
          
          echo "DOCKER CONTAINER TESTING COMPLETED"
      
      # ======================================================
      # PHASE 3: CLEANUP
      # ======================================================
      - name: Cleanup Docker Container
        if: always()
        run: |
          echo "PHASE 3: CLEANUP"
          echo "================"
          echo ""
          
          # stop and remove container
          if [ "$(docker ps -q -f name=test-wicked)" ]; then
            echo "Stopping container..."
            docker stop test-wicked
            echo "Container stopped"
          fi
          
          if [ "$(docker ps -aq -f name=test-wicked)" ]; then
            echo "Removing container..."
            docker rm test-wicked
            echo "Container removed"
          fi
          echo ""
          
          echo "CLEANUP COMPLETED"
      
      # ======================================================
      # PHASE 4: DOCKER JOB SUMMARY
      # ======================================================
      - name: Docker Job Summary
        if: always()
        run: |
          echo "PHASE 4: DOCKER JOB SUMMARY"
          echo "==========================="
          echo ""
          echo "Results:"
          echo "--------"
          echo "Docker Build.........: ${{ steps.build-phase.conclusion || 'unknown' }}"
          echo "Container Test.......: ${{ steps.test-phase.conclusion || 'unknown' }}"
          echo ""
          echo "Overall Status.......: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "DOCKER JOB COMPLETED SUCCESSFULLY!"
            echo "Docker image built"
            echo "Container tested with secrets"
            echo "Ready for deployment"
          else
            echo "Docker job failed"
          fi
          
          echo ""
          echo "========================================"
          echo "DOCKER JOB EXECUTION COMPLETE"
          echo "========================================"

  # ============================================================
  # DOCUMENTATION BUILD JOB
  # ============================================================
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MkDocs
        run: pip install mkdocs mkdocs-material pymdown-extensions

      - name: Validate documentation structure
        run: |
          echo "Checking documentation files..."
          test -f mkdocs.yml || (echo "mkdocs.yml not found" && exit 1)
          test -d docs || (echo "docs directory not found" && exit 1)
          test -f docs/index.md || (echo "docs/index.md not found" && exit 1)
          echo "Documentation structure is valid"

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: site/
          retention-days: 7
