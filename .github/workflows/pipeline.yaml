# ============================================================
# PIPELINE
# ============================================================
name: CI/CD Pipeline 

on:
  push:
    #branches: [UAT, feature/*]
    branches: [feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ci-pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      FLASK_ENV: development
      SECRET_KEY: ci-pipeline-key-${{ github.run_id }}-${{ github.run_attempt }}
      DEV_DATABASE_URL: sqlite:///test.db
      TEST_DATABASE_URL: "sqlite:///:memory:"
      PROD_DATABASE_URL: sqlite:///test.db  
    
    steps:
      # ======================================================
      # STEP 0: CHECKOUT CODE
      # ======================================================
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ======================================================
      # STEP 1: SETUP PYTHON
      # ======================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # ======================================================
      # PHASE 0: SETUP ENVIRONMENT (AS PER LOCAL)
      # ======================================================
      - name: Setup Virtual Environment
        id: setup-phase
        run: |
          echo "PHASE 0: SETUP ENVIRONMENT"
          echo "============================="
          echo ""
          echo "Going to: flask_app/src/main"
          cd flask_app/src/main
          echo "Current directory: $(pwd)"
          echo ""
          
          # 1. Create venv (exactly as you do locally)
          echo "Creating virtual environment..."
          python3 -m venv venv
          echo "Venv created at: $(pwd)/venv"
          echo ""
          
          # 2. Activate venv
          echo "Activating venv..."
          source venv/bin/activate
          echo "Venv activated"
          echo "Python: $(which python)"
          echo "Version: $(python --version)"
          echo ""
          
          # 3. Update pip
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          echo ""
          
          # 4. Install requirements (one level up)
          echo "Installing requirements.txt..."
          echo "From: ../requirements.txt"
          pip install -r ../requirements.txt
          echo "Requirements installed"
          echo ""
          
          # 5. Install extra packages (pytest is already in requirements)
          echo "Checking pytest..."
          if ! pip show pytest >/dev/null 2>&1; then
            echo "Installing pytest..."
            pip install pytest
          fi
          echo "Pytest available"
          echo ""
          
          # 6. Basic verification only
          echo "Basic verification..."
          pip show Flask pytest | grep -E "^(Name|Version):" || true
          echo ""
          
          # 7. Verificar configuração CSRF
          echo "Verifying CSRF configuration..."
          python3 -c "
          import os
          print(f'FLASK_ENV: {os.environ.get(\"FLASK_ENV\")}')
          print(f'SECRET_KEY exists: {\"SECRET_KEY\" in os.environ}')
          from config import config
          cfg = config[os.environ.get(\"FLASK_ENV\", \"development\")]()
          print(f'Config class: {cfg.__class__.__name__}')
          print(f'WTF_CSRF_ENABLED: {cfg.WTF_CSRF_ENABLED}')
          print(f'SECRET_KEY length: {len(cfg.SECRET_KEY) if cfg.SECRET_KEY else 0}')
          print('✅ CSRF should be ENABLED for SonarQube')
          "
          echo ""
          
          echo "SETUP COMPLETED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 1: SECURITY SCAN (SAST) - BANDIT
      # ======================================================
      - name: Security Scan (SAST)
        id: security-phase
        run: |
          echo "PHASE 1: SECURITY SCAN"
          echo "========================="
          echo ""
          
          # 1. Activate venv and go to project
          echo "Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "Directory: $(pwd)"
          echo ""
          
          # 2. Install bandit if needed
          echo "Checking bandit..."
          if ! pip show bandit >/dev/null 2>&1; then
            echo "Installing bandit..."
            pip install bandit
          fi
          echo "Bandit available"
          echo ""
          
          # 3. Run quick scan 
          echo "Running quick security scan..."
          bandit -r . -f json -o bandit-results.json || echo "Scan failed, continuing..."
          
          if [ -f "bandit-results.json" ]; then
            echo "Scan result saved in bandit-results.json"
          fi
          echo ""
          echo "SECURITY PHASE COMPLETED"
      
      # ======================================================
      # PHASE 2: RUN TESTS WITH PYTEST
      # ======================================================
      - name: Run Tests with pytest
        id: test-phase
        run: |
          echo "PHASE 2: RUN TESTS"
          echo "====================="
          echo ""
          
          # 1. Activate venv and go to project
          echo "Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "Directory: $(pwd)"
          echo "Python: $(which python)"
          echo ""
          
          # 2. Check test structure
          echo "Test structure:"
          find . -name "*test*.py" -type f | head -10 || echo "No tests found"
          echo ""
          
          echo "Running pytest..."
          cd "${{ github.workspace }}/flask_app/src"
          python -m pytest tests/ -v --cov=app --cov-report=term-missing
          
          echo ""
          echo "TESTS EXECUTED SUCCESSFULLY"


      # ======================================================
      # PHASE 3: BUILD DOCKER IMAGE DEV
      # ======================================================

      - name: Build Docker Image
        run: |
          cd flask_app/src
          docker build -f Dockerfile.dev -t wicked-adventures:ci .
          # test in development
          docker run --rm wicked-adventures:ci python -c "import sys; sys.path.insert(0, '/app/main'); import app; print('Docker CI image works')"

          echo "DOCKER BUILD COMPLETED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 4: PIPELINE SUMMARY
      # ======================================================
      - name: Pipeline Summary
        if: always()
        run: |
          echo "PHASE 3: PIPELINE SUMMARY"
          echo "============================"
          echo ""
          echo "Results:"
          echo "--------"
          echo "Setup Environment....: ${{ steps.setup-phase.conclusion || 'unknown' }}"
          echo "Security Scan........: ${{ steps.security-phase.conclusion || 'unknown' }}"
          echo "Test Execution.......: ${{ steps.test-phase.conclusion || 'unknown' }}"
          echo ""
          echo "Overall Status.......: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "PIPELINE COMPLETED SUCCESSFULLY!"
            echo "Environment configured correctly"
            echo "Tests executed"
            echo "Docker Build completed"
            echo "Ready for next steps"
          else
            echo "Some phases failed"
            echo "Check logs for details"
          fi
          
          echo ""
          echo "========================================"
          echo "PIPELINE EXECUTION COMPLETE"
          echo "========================================"